# AgenticSeek 架构设计文档

## 项目概述

AgenticSeek 是一个100%本地运行的智能AI助手，作为Manus AI的开源替代方案。它提供语音交互、自主网页浏览、代码编写和复杂任务规划功能，完全在用户本地硬件上运行，确保数据隐私和零云依赖。

### 核心特性
- 🔒 **完全本地化** - 所有数据处理在本地进行，无云端依赖
- 🌐 **智能网页浏览** - 自主搜索、阅读网页并提取信息
- 💻 **自主编程助手** - 支持Python、C、Go、Java等多种语言
- 🧠 **智能代理选择** - 自动选择最适合的AI代理处理任务
- 📋 **复杂任务规划** - 将大型任务分解为可执行的子任务
- 🎙️ **语音交互** - 支持语音输入和文本转语音输出

## 技术栈

### 后端技术栈
- **Python 3.10+** - 主要开发语言
- **FastAPI** - 异步Web框架，提供RESTful API
- **Celery** - 分布式任务队列，处理异步任务
- **Redis** - 内存数据库，用于缓存和任务队列
- **Selenium** - 浏览器自动化框架
- **Transformers** - 机器学习模型库
- **Adaptive Classifier** - 自适应分类器
- **Uvicorn** - ASGI服务器

### 前端技术栈
- **React 19.1.0** - 前端框架
- **Axios** - HTTP客户端
- **React Markdown** - Markdown渲染

### 基础设施
- **Docker & Docker Compose** - 容器化部署
- **SearxNG** - 开源搜索引擎
- **Valkey/Redis** - 键值存储和任务队列

### LLM支持
- **Ollama** - 本地LLM运行时
- **LM Studio** - 本地LLM管理
- **OpenAI API** - 云端LLM接口
- **其他API** - Anthropic、Google、Together等

## 系统架构

### 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户交互层                                  │
├─────────────────────┬─────────────────────┬─────────────────────┤
│   Web Frontend      │      CLI Client     │   Voice Interface   │
│   (React App)       │     (Python)        │   (TTS/STT)        │
└─────────────────────┴─────────────────────┴─────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API网关层                                   │
├─────────────────────────────────────────────────────────────────┤
│                    FastAPI Server                               │
│              (api.py - RESTful API)                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     交互管理层                                    │
├─────────────────────────────────────────────────────────────────┤
│                  Interaction Manager                            │
│            (interaction.py - 会话管理)                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     智能路由层                                    │
├─────────────────────────────────────────────────────────────────┤
│                   Agent Router                                  │
│        (router.py - 智能代理选择与任务分发)                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     代理执行层                                    │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────┤
│ CasualAgent │ CoderAgent  │ FileAgent   │BrowserAgent │Planner  │
│   (对话)     │   (编程)     │  (文件)      │  (浏览器)    │ (规划)   │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     工具执行层                                    │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────┤
│   Python    │  Bash/Shell │     C       │    Go       │  Java   │
│ Interpreter │ Interpreter │ Interpreter │ Interpreter │Interp.  │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────┤
│ Web Search  │ File Finder │ MCP Client  │ Flight API  │  ...    │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     LLM提供商层                                   │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────┤
│   Ollama    │  LM Studio  │   OpenAI    │ Anthropic   │Together │
│  (本地)      │   (本地)     │   (API)     │   (API)     │ (API)   │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────┤
│  DeepSeek   │DeepSeek Pvt │   Google    │ OpenRouter  │自定义API │
│  (API)      │  (私有部署)   │   (API)     │   (API)     │ (兼容)   │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────┘
```

### 2. 核心组件详解

#### 2.1 智能路由系统 (Agent Router)

**职责**：
- 分析用户查询的语言和复杂度
- 选择最适合的代理处理任务
- 管理代理间的协调

**核心算法**：
```python
def select_agent(self, text: str) -> Agent:
    # 1. 语言检测和翻译
    lang = self.lang_analysis.detect_language(text)
    text = self.lang_analysis.translate(text, lang)
    
    # 2. 复杂度评估
    complexity = self.estimate_complexity(text)
    if complexity == "HIGH":
        return self.find_planner_agent()
    
    # 3. 代理选择投票
    best_agent = self.router_vote(text, labels)
    return best_agent
```

**设计模式**：策略模式 + 模板方法模式

#### 2.2 代理系统 (Agents)

##### CasualAgent (对话代理)
- **职责**：处理日常对话和简单查询
- **工具**：无特殊工具
- **使用场景**：问候、简单问答

##### CoderAgent (编程代理)
- **职责**：编写、执行和调试代码
- **工具**：Python、C、Go、Java、Bash解释器
- **工作流程**：
  1. 理解编程需求
  2. 生成代码
  3. 执行并验证
  4. 错误处理和修复

##### FileAgent (文件代理)
- **职责**：文件系统操作
- **工具**：FileFinder
- **功能**：文件查找、读取、写入、目录操作

##### BrowserAgent (浏览器代理)
- **职责**：自主网页浏览和信息提取
- **工具**：Selenium WebDriver、SearxNG搜索
- **工作流程**：
  1. 接收搜索查询
  2. 执行网页搜索
  3. 智能导航页面
  4. 提取相关信息
  5. 填写表单（如需要）

##### PlannerAgent (规划代理)
- **职责**：复杂任务分解和多代理协调
- **工作流程**：
  1. 分析复杂任务
  2. 生成JSON格式的执行计划
  3. 协调多个代理按序执行
  4. 整合最终结果

#### 2.3 工具系统 (Tools)

**设计模式**：模板方法模式

**基础架构**：
```python
class Tools:
    @abstractmethod
    def execute(self, blocks: [str], safety: bool) -> str:
        """执行工具逻辑"""
        pass
    
    @abstractmethod
    def execution_failure_check(self, output: str) -> bool:
        """检查执行是否失败"""
        pass
    
    @abstractmethod
    def interpreter_feedback(self, output: str) -> str:
        """生成反馈信息"""
        pass
```

**工具类型**：
- **代码解释器**：PyInterpreter, CInterpreter, GoInterpreter, JavaInterpreter
- **系统工具**：BashInterpreter, FileFinder
- **网络工具**：searxSearch, webSearch
- **API工具**：flightSearch, mcpFinder

#### 2.4 LLM提供商抽象层

**设计模式**：工厂模式 + 适配器模式

```python
class Provider:
    def __init__(self, provider_name, model, server_address, is_local):
        self.provider_name = provider_name
        self.model = model
        self.server_address = server_address
        self.is_local = is_local
```

**支持的提供商**：
- **本地提供商**：Ollama, LM Studio, llamacpp
- **云端提供商**：OpenAI, Anthropic, Google, Together
- **企业提供商**：DeepSeek (公有云), DeepSeek Private (私有部署)
- **开源兼容**：任何OpenAI API兼容的服务

### 3. 数据流架构

#### 3.1 用户请求处理流程

```
用户输入 → API网关 → 交互管理器 → 路由器 → 代理选择 → 工具执行 → LLM推理 → 结果返回
     ↓        ↓        ↓       ↓       ↓        ↓        ↓        ↓
   语音/文本  验证请求   会话管理  复杂度分析  代理实例化  工具调用   模型推理   格式化输出
```

#### 3.2 复杂任务分解流程

```
复杂任务 → PlannerAgent → JSON计划生成 → 任务分发 → 多代理执行 → 结果聚合
    ↓         ↓           ↓           ↓        ↓        ↓
  高复杂度   任务分析     依赖关系图    代理调度   并行/串行   最终答案
```

### 4. 部署架构

#### 4.1 Docker容器化架构

```yaml
services:
  # 前端服务
  frontend:
    - React应用
    - 端口：3000
    - 热重载开发模式
  
  # 后端API服务
  backend:
    - FastAPI应用
    - 端口：7777
    - 多语言运行时支持
  
  # 搜索引擎服务
  searxng:
    - SearxNG实例
    - 端口：8080
    - 隐私保护搜索
  
  # 缓存和任务队列
  redis:
    - Valkey/Redis
    - 内存缓存
    - Celery任务队列
```

#### 4.2 网络拓扑

```
Internet ←→ [SearxNG:8080] ←→ [Backend:7777] ←→ [Frontend:3000] ←→ User
               ↓                    ↓
          [Redis:6379] ←→ [Celery Workers]
               ↓
        [Local LLM Services]
        - Ollama:11434 (支持OLLAMA_BASE_URL自定义)
        - LM Studio:1234
```

## 核心设计模式和原则

### 1. 设计模式

#### 代理模式 (Agent Pattern)
- 每个Agent作为特定功能域的代理
- 提供统一的接口抽象
- 支持动态代理选择

#### 策略模式 (Strategy Pattern)
- 路由器根据任务类型选择不同策略
- LLM提供商的动态切换
- 工具执行策略的选择

#### 模板方法模式 (Template Method)
- 所有工具继承Tools基类
- 统一的执行、验证、反馈流程
- 具体实现由子类定义

#### 工厂模式 (Factory Pattern)
- Provider工厂创建不同的LLM客户端
- 代理工厂根据类型创建代理实例

### 2. 架构原则

#### 单一职责原则 (SRP)
- 每个代理专注于特定功能域
- 工具类职责明确单一
- 模块间低耦合

#### 开闭原则 (OCP)
- 支持新代理类型扩展
- 工具系统可插拔
- LLM提供商可扩展

#### 依赖倒置原则 (DIP)
- 代理依赖抽象的工具接口
- 应用层依赖抽象的LLM接口
- 面向接口编程

## 安全和隐私设计

### 1. 数据隐私
- **本地优先**：默认使用本地LLM，避免数据泄露
- **可选云端**：仅在用户明确配置API密钥时使用云服务
- **无日志存储**：敏感数据不持久化存储

### 2. 代码执行安全
- **沙箱隔离**：代码在受限环境中执行
- **权限控制**：限制文件系统访问范围
- **安全扫描**：执行前的安全检查

### 3. 网络安全
- **请求验证**：API请求的身份验证
- **速率限制**：防止滥用和DDoS攻击
- **HTTPS支持**：加密数据传输

## 性能优化策略

### 1. 缓存策略
- **Redis缓存**：频繁查询结果缓存
- **模型缓存**：LLM响应缓存
- **浏览器缓存**：页面内容缓存

### 2. 异步处理
- **Celery任务队列**：长时间运行任务异步化
- **FastAPI异步**：支持并发请求处理
- **流式响应**：LLM流式输出

### 3. 资源管理
- **连接池**：数据库和HTTP连接复用
- **内存优化**：及时释放不用的模型和数据
- **进程管理**：合理的工作进程数量

## 可扩展性设计

### 1. 水平扩展
- **微服务架构**：独立部署和扩展
- **负载均衡**：多实例负载分发
- **状态分离**：无状态服务设计

### 2. 功能扩展
- **插件架构**：新工具和代理的热插拔
- **配置驱动**：通过配置文件控制功能
- **API版本化**：向后兼容的API设计

## 监控和日志

### 1. 应用监控
- **性能指标**：响应时间、吞吐量、错误率
- **资源监控**：CPU、内存、磁盘使用
- **业务监控**：代理选择准确率、任务成功率

### 2. 日志系统
- **分级日志**：DEBUG、INFO、WARNING、ERROR
- **结构化日志**：JSON格式便于查询
- **日志轮转**：避免日志文件过大

## 测试策略

### 1. 单元测试
- **代理测试**：各代理功能验证
- **工具测试**：工具执行正确性
- **路由测试**：代理选择准确性

### 2. 集成测试
- **端到端测试**：完整用户场景
- **API测试**：接口功能验证
- **性能测试**：负载和压力测试

## 未来发展规划

### 1. 短期目标
- **Web界面优化**：更好的用户体验
- **多语言支持**：扩展TTS/STT语言
- **性能优化**：响应速度提升

### 2. 长期目标
- **MCP协议支持**：模型上下文协议集成
- **多模态能力**：图像、视频处理
- **分布式部署**：跨机器协作

### 3. 社区发展
- **开源贡献**：吸引更多开发者参与
- **文档完善**：详细的开发和使用文档
- **生态建设**：插件和扩展生态系统

---

*本文档版本：v1.0*  
*更新日期：2025年6月25日*  
*维护者：AgenticSeek开发团队*
